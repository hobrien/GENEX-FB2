---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
source("plot_SMR.r") 

PlotEQTL<-function(geneID, snp, pos, chr, counts, target, snp_header) {
  snp_pos <- paste(chr, pos, sep=":")
  expression <- counts %>% filter(Id == geneID) %>%  
    dplyr::select(-Id, -SYMBOL) %>%
    gather("Sample", "value") %>%
    dplyr::select(Sample, value) %>%
    left_join(target)
  genotypes <- system(paste("bcftools view -H -r", snp_pos, "../Shiny/GENEX-FB2/Data/combined_filtered.vcf.gz"), intern=TRUE) %>%
    str_split('\t')
  ref <- genotypes[[1]][4]
  alt <- genotypes[[1]][5]
  data <- tibble(Sample=snp_header[[1]][10:length(genotypes[[1]])], geno=genotypes[[1]][10:length(genotypes[[1]])]) %>%
    separate(geno, c("GT", "DS", "GP" ), sep=":") %>%
    full_join(expression) %>%
    filter(!is.na(GT)) %>%
    mutate(DS=as.numeric(DS), 
           geno=factor(ifelse(GT=='0|0', paste0(UQ(ref), UQ(ref)),
                              ifelse(GT=='1|1', paste0(UQ(alt), UQ(alt)),
                                     paste0(UQ(ref), UQ(alt)))),
                       levels=c(paste0(UQ(ref), UQ(ref)), paste0(UQ(ref), UQ(alt)), 
                                paste0(UQ(alt), UQ(alt)) ))
           )
  #mean <- data %>% group_by(genotype) %>% summarise(mean = mean(value))
  title<-paste0(geneID, ' x ', snp)
  plot<-  ggplot(data, aes(y=value, x=DS)) + 
    #geom_errorbar(aes(ymin=mean, ymax=mean), colour='black', size=1, width=.5, data=mean) +
    geom_smooth(method='lm', colour='black') +
    geom_quasirandom(aes(colour=geno), width=0.05, alpha=.5) + 
    ylab("Normalised Counts") +
    xlab('Dosage') +
    #scale_x_discrete(breaks=c(0,1,2), labels=c('Ref', 'Het', 'Alt')) +
    side_theme() +
    scale_colour_brewer(type = "qual", palette = 6) +
    ggtitle(title) +
    theme(legend.position="right") +
    labs(color='Best Guess\nGenotype')
  plot
}

geneID <- 'ENSG00000275126'
snp <- 'rs200995'
chr <- 6
pos <- 27845916
counts <- read_tsv("../Shiny/GENEX-FB2/Data/counts.txt") %>% select(-Chr, -gene_type, -ChrType)
colnames(counts) <- str_replace_all(colnames(counts), 'norm.', '')
target <- read_tsv('../Data/SampleInfo.txt', col_types = cols(Sample='c'))
snp_header <- system("bcftools view -h ../Shiny/GENEX-FB2/Data/combined_filtered.vcf.gz | tail -1", intern=TRUE) %>%
  str_split('\t')
PlotEQTL(geneID, snp, pos, chr, counts, target, snp_header)

```

- 7 loci have significnat SMR p-values when correcting for the number of loci in the output and p_HEIDI>.05
    - only 806 genes are tested because the p-value cutoff for eQTLs is 5e-8
    - 3 survive when correcting for 29720 tested genes (p<1.68e-06)
    - 3 located in one (dodgy) region of chr15
- 9 additional loci have significant SMR p-values but significant heterogeneity (p_HEIDI<.05)
    - all of these are on Chr6

```{r}
mysmr <- read_delim("~/BTSync/FetalRNAseq/Github/GENEX-FB2/SMR/mysmr.smr",
"\t", escape_double = FALSE, trim_ws = TRUE) 

smr <- mysmr %>% select(-probeID, -ProbeChr, -Probe_bp, -A1, -A2, -Freq, -b_GWAS, -se_GWAS, -b_eQTL, -se_eQTL, -b_SMR, -se_SMR, -nsnp_HEIDI)

filter(smr, p_SMR<.05/806 & p_HEIDI>.05) %>% arrange(p_SMR) %>% left_join(select(hglft_genome_26c7_734240, GeneID, Trait, eQTL_study), by=c('Gene' = 'GeneID')) %>% View()


filter(hglft_genome_26c7_734240, Trait=='Schizophrenia') %>% group_by(eQTL_study) %>% summarise(n=n()) %>% View()
```

# HIST1H4L (histone cluster 1 H4 family member l)
- CLOZUK locus 1 (xMHC)
```{r}
#smr --bfile ../Genotypes/Plink/genotypes --gwas-summary CLOZUK_recoded.txt --beqtl-summary mybesd --out HIST1H4L  --plot --probe ENSG00000275126 --probe-wind 500 --gene-list ../Data/geneloc_smr.txt
SMRData = ReadSMRData("../SMR/HIST1H4L.ENSG00000275126.txt")
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=500, max_anno_probe=16)
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=10, max_anno_probe=16)
SMREffectPlot(data=SMRData, trait_name="sczx")
PlotEQTL('ENSG00000275126', 'rs200995', 27845916, 6, counts, target, snp_header)

```

# AC243562.2 (processed pseudogene) / CSPG4P11 (Chondroitin Sulfate Proteoglycan 4 Pseudogene 11) / UBE2Q2L (ubiquitin conjugating enzyme E2 Q2 like)
- CLOZUK # 76 

```{r}
#smr --bfile ../Genotypes/Plink/genotypes --gwas-summary CLOZUK_recoded.txt --beqtl-summary mybesd --out AC243562  --plot --probe ENSG00000259683 --probe-wind 500 --gene-list ../Data/geneloc_smr.txt
SMRData = ReadSMRData("../SMR/AC243562.ENSG00000259683.txt")
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=500, max_anno_probe=16)
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=250, max_anno_probe=16)
SMREffectPlot(data=SMRData, trait_name="sczx")
PlotEQTL('ENSG00000259683', 'rs4502182', 84254768, 15, counts, target, snp_header)
PlotEQTL('ENSG00000259726', 'rs6603022', 84161418, 15, counts, target, snp_header)
PlotEQTL('ENSG00000259511', 'rs62028142', 84386630, 15, counts, target, snp_header)
```


# LINC01068
- CLOZUK # 105 (NDFIP2, NDFIP2-AS1, RBM26, RBM26-AS1)
```{r}
#smr --bfile ../Genotypes/Plink/genotypes --gwas-summary CLOZUK_recoded.txt --beqtl-summary mybesd --out LINC01068  --plot --probe ENSG00000227676 --probe-wind 500 --gene-list ../Data/geneloc_smr.txt
SMRData = ReadSMRData("../SMR/LINC01068.ENSG00000227676.txt")
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=500, max_anno_probe=16)
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=25, max_anno_probe=16)
SMREffectPlot(data=SMRData, trait_name="sczx") 
PlotEQTL('ENSG00000227676', 'rs1212082', 79552633, 13, counts, target, snp_header)
```

# ABCB9 (ATP binding cassette subfamily B member 9)
- CLOZUK #11
```{r}
#smr --bfile ../Genotypes/Plink/genotypes --gwas-summary CLOZUK_recoded.txt --beqtl-summary mybesd --out ABCB9  --plot --probe ENSG00000150967 --probe-wind 500 --gene-list ../Data/geneloc_smr.txt
SMRData = ReadSMRData("../SMR/ABCB9.ENSG00000150967.txt")
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=500, max_anno_probe=16)
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=100, max_anno_probe=16)
SMREffectPlot(data=SMRData, trait_name="sczx")
PlotEQTL('ENSG00000150967', 'rs1790106', 123107049, 12, counts, target, snp_header)
```

# WBP2NL (WBP2 N-terminal like)
- CLOZUK #14
```{r}
#smr --bfile ../Genotypes/Plink/genotypes --gwas-summary CLOZUK_recoded.txt --beqtl-summary mybesd --out WBP2NL  --plot --probe ENSG00000183066 --probe-wind 500 --gene-list ../Data/geneloc_smr.txt
SMRData = ReadSMRData("../SMR/WBP2NL.ENSG00000183066.txt")
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=500, max_anno_probe=16)
SMRLocusPlot(data=SMRData, smr_thresh=.05/806, heidi_thresh=0.05, plotWindow=100, max_anno_probe=16)
SMREffectPlot(data=SMRData, trait_name="sczx")
PlotEQTL('ENSG00000183066', 'rs5996092', 41948404, 22, counts, target, snp_header)
```
